# 内部临时表使用

在某些情况下，服务器在处理语句时会创建内部临时表。用户无法直接控制何时发生这种情况。

服务器在以下条件下创建临时表：

* 对描述一些例外情况 UNION 语句的评估。
* 评估某些视图，例如使用 TEMPTABLE 算法、UNION 或聚合。
* 派生表的评估（参见"Derived Tables"）。
* 公用表表达式的评估（请参阅 "WITH（common table expressions）"）。
* 为子查询或半连接物化(semijoin materialization)创建的表（请参阅第 “优化子查询、派生表、视图引用和公用表表达式”）。
* 评估包含 ORDER BY 子句和不同 GROUP BY 子句的语句，或者 ORDER BY 或 GROUP BY 包含来自连接队列中第一个表以外的表的列。
* 结合 ORDER BY 评估 DISTINCT 可能需要一个临时表。
* 对于使用 SQL_SMALL_RESULT 修饰符的查询，MySQL 使用内存中的临时表，除非查询还包含需要磁盘存储的元素（稍后描述）。
* 为了评估从同一个表中选择和插入的 INSERT ... SELECT 语句，MySQL 创建一个内部临时表来保存来自 SELECT 的行，然后将这些行插入到目标表中。请参阅第 13.2.6.1 节，“INSERT ... SELECT 语句”。
* 评估多表 UPDATE 语句。
* 评估 GROUP_CONCAT() 或 COUNT(DISTINCT) 表达式。
* 窗口函数的评估（参见第 12.21 节，“窗口函数”）在必要时使用临时表。

要确定语句是否需要临时表，请使用 EXPLAIN 并检查 Extra 列以查看它是否显示使用临时表（请参阅第 8.8.1 节，“使用 EXPLAIN 优化查询”）。 EXPLAIN 不一定说将临时表用于派生或物化临时表。对于使用窗口函数的语句，使用 FORMAT=JSON 的 EXPLAIN 始终提供有关窗口步骤的信息。如果窗口函数使用临时表，则为每个步骤指明。

```mysql
mysql> show global status like 'created_tmp%';
+-------------------------+---------+
| Variable_name           | Value   |
+-------------------------+---------+
| Created_tmp_disk_tables | 0       |
| Created_tmp_files       | 243399  |
| Created_tmp_tables      | 1617974 |
+-------------------------+---------+
3 rows in set (0.03 sec)
```

Created_tmp_disk_tables / Created_tmp_tables * 100% <= 25%

Monitoring Internal Temporary Table Creation
When an internal temporary table is created in memory or on disk, the server increments the Created_tmp_tables value. When an internal temporary table is created on disk, the server increments the Created_tmp_disk_tables value. If too many internal temporary tables are created on disk, consider adjusting the engine-specific limits described in Internal Temporary Table Storage Engine.
在内存或磁盘上创建内部临时表时，服务器会递增 Created_tmp_tables 值。在磁盘上创建内部临时表时，服务器会增加 Created_tmp_disk_tables 值。如果在磁盘上创建了太多内部临时表，请考虑调整内部临时表存储引擎中描述的引擎特定限制。
Note
Due to a known limitation, Created_tmp_disk_tables does not count on-disk temporary tables created in memory-mapped files. By default, the TempTable storage engine overflow mechanism creates internal temporary tables in memory-mapped files. See Internal Temporary Table Storage Engine.
由于已知限制，Created_tmp_disk_tables 不计算在内存映射文件中创建的磁盘临时表。默认情况下，TempTable 存储引擎溢出机制在内存映射文件中创建内部临时表。
The memory/temptable/physical_ram and memory/temptable/physical_disk Performance Schema instruments can be used to monitor TempTable space allocation from memory and disk. memory/temptable/physical_ram reports the amount of allocated RAM. memory/temptable/physical_disk reports the amount of space allocated from disk when memory-mapped files are used as the TempTable overflow mechanism. If the physical_disk instrument reports a value other than 0 and memory-mapped files are used as the TempTable overflow mechanism, a TempTable memory limit was reached at some point. Data can be queried in Performance Schema memory summary tables such as memory_summary_global_by_event_name. See Section 27.12.20.10, “Memory Summary Tables”.
memory/temptable/physical_ram 和 memory/temptable/physical_disk 性能模式工具可用于监控内存和磁盘的 TempTable 空间分配。 memory/temptable/physical_ram 报告分配的 RAM 量。 memory/temptable/physical_disk 报告当内存映射文件用作 TempTable 溢出机制时从磁盘分配的空间量。如果 physical_disk 仪器报告的值不是 0，并且内存映射文件用作 TempTable 溢出机制，则在某个时候达到了 TempTable 内存限制。可以在 Performance Schema 内存汇总表中查询数据，例如 memory_summary_global_by_event_name。